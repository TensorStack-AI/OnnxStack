
# # controlnet residual
# if block_controlnet_hidden_states is not None and block.context_pre_only is False:
#     interval_control = len(self.transformer_blocks) / len(block_controlnet_hidden_states)
#     hidden_states = hidden_states + block_controlnet_hidden_states[int(index_block / interval_control)]


# ONNX PATCHED: controlnet residual
if block_controlnet_hidden_states is not None and block.context_pre_only is False:
    valid_count = block_controlnet_hidden_states.shape[0]
    interval_control = len(self.transformer_blocks) / valid_count
    control_index = (index_block / interval_control)
    control_index = control_index.floor().long().clamp(max=block_controlnet_hidden_states.shape[0] - 1)
    selected = block_controlnet_hidden_states.index_select(0, control_index)
    hidden_states = hidden_states + selected.squeeze(0)